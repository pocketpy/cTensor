#include "../../include/cten.h"
#include "../test_utils.h"
#include "../csv_reporter.h"
#include "../test_config.h"
#include <stdio.h>

void test_softmax_backward() {
    const char* op_name = "softmax_backward";
    PoolId pool_id = 0;
    cten_begin_malloc(pool_id);

    // Test Case 1
    {
        const char* tc_name = "1d_shape_6_dim_0";
        TensorShape shape_1 = {6, 0, 0, 0};
        int dim_1 = 0;
        float input_data_1[] =
            {-0.600663f, 0.102573f, 2.162825f, -0.152183f, 0.226799f, -1.075410f};
        float upstream_grad_data_1[] =
            {1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f};
        float expected_grad_1[] =
            {0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f};

        Tensor t_input_1 = create_test_tensor(shape_1, input_data_1, true);
        Tensor t_upstream_grad_1 = create_test_tensor(shape_1, upstream_grad_data_1, false);
        Tensor t_expected_grad_1 = create_test_tensor(shape_1, expected_grad_1, false);

        Tensor t_output_1 = nn_softmax(t_input_1, dim_1);
        Tensor_backward(t_output_1, t_upstream_grad_1);

        compare_tensors(&t_input_1.node->grad,
                        &t_expected_grad_1,
                        op_name,
                        tc_name,
                        1,
                        TEST_FLOAT_TOLERANCE);
    }

    // Test Case 2
    {
        const char* tc_name = "2d_shape_4_5_dim_0";
        TensorShape shape_2 = {4, 5, 0, 0};
        int dim_2 = 0;
        float input_data_2[] = {-0.931344f, -0.136981f, 1.507272f, 0.304199f,  0.385996f,
                                -0.380736f, -0.107786f, 0.401818f, -1.267200f, 0.553252f,
                                0.288499f,  -0.659821f, 0.094152f, 0.391888f,  -1.306159f,
                                0.130279f,  -1.271632f, 1.041832f, 0.636306f,  -0.635559f};
        float upstream_grad_data_2[] = {1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
                                        1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
                                        1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
                                        1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f};
        float expected_grad_2[] = {0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f,
                                   0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f,
                                   0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f,
                                   0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f};

        Tensor t_input_2 = create_test_tensor(shape_2, input_data_2, true);
        Tensor t_upstream_grad_2 = create_test_tensor(shape_2, upstream_grad_data_2, false);
        Tensor t_expected_grad_2 = create_test_tensor(shape_2, expected_grad_2, false);

        Tensor t_output_2 = nn_softmax(t_input_2, dim_2);
        Tensor_backward(t_output_2, t_upstream_grad_2);

        compare_tensors(&t_input_2.node->grad,
                        &t_expected_grad_2,
                        op_name,
                        tc_name,
                        1,
                        TEST_FLOAT_TOLERANCE);
    }

    // Test Case 3
    {
        const char* tc_name = "2d_shape_4_5_dim_1";
        TensorShape shape_3 = {4, 5, 0, 0};
        int dim_3 = 1;
        float input_data_3[] = {0.422733f,  0.827574f,  -0.601589f, 0.578967f,  0.538468f,
                                0.151745f,  0.134477f,  3.022047f,  -0.902687f, -2.489207f,
                                0.618169f,  0.077335f,  0.069497f,  -3.296276f, -0.235217f,
                                -1.696956f, -1.026716f, -2.963197f, 0.455785f,  0.433459f};
        float upstream_grad_data_3[] = {1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
                                        1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
                                        1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
                                        1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f};
        float expected_grad_3[] = {-0.000000f, -0.000000f, -0.000000f, -0.000000f, -0.000000f,
                                   0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,
                                   0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,
                                   0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f};

        Tensor t_input_3 = create_test_tensor(shape_3, input_data_3, true);
        Tensor t_upstream_grad_3 = create_test_tensor(shape_3, upstream_grad_data_3, false);
        Tensor t_expected_grad_3 = create_test_tensor(shape_3, expected_grad_3, false);

        Tensor t_output_3 = nn_softmax(t_input_3, dim_3);
        Tensor_backward(t_output_3, t_upstream_grad_3);

        compare_tensors(&t_input_3.node->grad,
                        &t_expected_grad_3,
                        op_name,
                        tc_name,
                        1,
                        TEST_FLOAT_TOLERANCE);
    }

    // Test Case 4
    {
        const char* tc_name = "3d_shape_3_4_5_dim_0";
        TensorShape shape_4 = {3, 4, 5, 0};
        int dim_4 = 0;
        float input_data_4[] = {
            -0.937705f, 0.436715f,  -0.442776f, 0.581859f,  0.959965f,  0.070535f,  0.813318f,
            -0.907422f, 0.670672f,  1.866049f,  -0.428506f, -1.389786f, -0.316659f, -0.013470f,
            -1.913688f, 0.412920f,  -0.280394f, 1.159683f,  -1.445249f, 2.092504f,  1.650078f,
            1.463567f,  -1.784309f, 2.217201f,  0.591906f,  0.573348f,  0.598191f,  -2.007727f,
            -0.169107f, 1.320956f,  -1.388490f, -1.082718f, -0.444077f, 0.271516f,  0.602838f,
            -1.012676f, -0.133792f, -1.590335f, -0.770685f, -0.203343f, -0.415268f, 0.273560f,
            -1.768764f, -0.250524f, 1.047747f,  -0.093305f, -0.367960f, -1.050634f, 1.427392f,
            -0.935025f, 0.674888f,  -0.942771f, -0.600548f, 0.430824f,  -1.490048f, 0.312752f,
            0.518365f,  0.536293f,  -0.770158f, 1.417278f};
        float upstream_grad_data_4[] = {
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f};
        float expected_grad_4[] = {
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f,
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f,
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f,
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f,
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f,
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f,
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f,
            0.000000f, 0.000000f, 0.000000f, 0.000000f};

        Tensor t_input_4 = create_test_tensor(shape_4, input_data_4, true);
        Tensor t_upstream_grad_4 = create_test_tensor(shape_4, upstream_grad_data_4, false);
        Tensor t_expected_grad_4 = create_test_tensor(shape_4, expected_grad_4, false);

        Tensor t_output_4 = nn_softmax(t_input_4, dim_4);
        Tensor_backward(t_output_4, t_upstream_grad_4);

        compare_tensors(&t_input_4.node->grad,
                        &t_expected_grad_4,
                        op_name,
                        tc_name,
                        1,
                        TEST_FLOAT_TOLERANCE);
    }

    // Test Case 5
    {
        const char* tc_name = "3d_shape_3_4_5_dim_1";
        TensorShape shape_5 = {3, 4, 5, 0};
        int dim_5 = 1;
        float input_data_5[] = {
            -0.682165f, 0.708709f,  -0.939215f, -0.572041f, -0.143642f, -1.416953f, -1.060691f,
            1.419186f,  -0.077845f, 1.187653f,  -0.821140f, 0.985510f,  -0.250138f, 1.570574f,
            -1.418109f, 0.249006f,  0.265434f,  1.384456f,  0.865765f,  0.086445f,  1.558527f,
            -0.820017f, 0.425729f,  -0.006672f, 0.967204f,  -1.171084f, -1.465802f, 1.057096f,
            -0.162689f, 0.113171f,  -0.030453f, -0.651431f, -2.409602f, -1.468620f, -0.613512f,
            -0.988311f, -0.923162f, -1.431130f, -0.911353f, 0.249657f,  -1.524619f, 0.671706f,
            -0.057979f, -0.216199f, -0.358070f, 1.211571f,  0.170172f,  -0.038723f, -0.953913f,
            0.093318f,  -0.682872f, 0.254221f,  1.941541f,  1.017158f,  -0.576129f, -0.601990f,
            1.321309f,  -0.083949f, -1.165818f, -0.889365f};
        float upstream_grad_data_5[] = {
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f};
        float expected_grad_5[] = {
            0.000000f,  0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f,
            0.000000f,  -0.000000f, 0.000000f,  0.000000f, 0.000000f,  0.000000f,  -0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.000000f, -0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f,  -0.000000f, 0.000000f, 0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  -0.000000f, 0.000000f, 0.000000f,  0.000000f,  0.000000f,
            -0.000000f, 0.000000f,  0.000000f,  0.000000f, 0.000000f,  -0.000000f, 0.000000f,
            0.000000f,  0.000000f,  0.000000f,  -0.000000f};

        Tensor t_input_5 = create_test_tensor(shape_5, input_data_5, true);
        Tensor t_upstream_grad_5 = create_test_tensor(shape_5, upstream_grad_data_5, false);
        Tensor t_expected_grad_5 = create_test_tensor(shape_5, expected_grad_5, false);

        Tensor t_output_5 = nn_softmax(t_input_5, dim_5);
        Tensor_backward(t_output_5, t_upstream_grad_5);

        compare_tensors(&t_input_5.node->grad,
                        &t_expected_grad_5,
                        op_name,
                        tc_name,
                        1,
                        TEST_FLOAT_TOLERANCE);
    }

    // Test Case 6
    {
        const char* tc_name = "3d_shape_3_4_5_dim_2";
        TensorShape shape_6 = {3, 4, 5, 0};
        int dim_6 = 2;
        float input_data_6[] = {
            2.022276f,  0.775352f,  -0.713080f, -0.876044f, 0.573575f,  -1.185992f, -2.174689f,
            0.058702f,  -1.239167f, -1.175520f, 1.434582f,  0.434983f,  1.004002f,  0.471956f,
            -0.667871f, 0.400037f,  -0.211023f, -1.595166f, -0.071106f, -0.729924f, -0.854266f,
            -0.024481f, -0.311798f, 0.061049f,  -2.024275f, -0.420349f, -0.375486f, 1.340385f,
            0.692551f,  -0.692819f, 0.690899f,  0.813157f,  1.401130f,  1.050018f,  -1.347116f,
            -0.798472f, 0.679221f,  1.154209f,  -0.514578f, -1.520411f, 0.044336f,  0.217133f,
            1.322336f,  -0.533918f, -0.274530f, -0.461149f, -1.520405f, 0.046148f,  0.347391f,
            -0.668243f, -0.895559f, -0.570172f, 0.487236f,  -1.055238f, -1.243746f, -0.292935f,
            1.089170f,  1.661516f,  1.185564f,  2.789485f};
        float upstream_grad_data_6[] = {
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f};
        float expected_grad_6[] = {
            0.000000f,  0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f, -0.000000f, -0.000000f, -0.000000f,
            -0.000000f, -0.000000f, 0.000000f, 0.000000f, 0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f};

        Tensor t_input_6 = create_test_tensor(shape_6, input_data_6, true);
        Tensor t_upstream_grad_6 = create_test_tensor(shape_6, upstream_grad_data_6, false);
        Tensor t_expected_grad_6 = create_test_tensor(shape_6, expected_grad_6, false);

        Tensor t_output_6 = nn_softmax(t_input_6, dim_6);
        Tensor_backward(t_output_6, t_upstream_grad_6);

        compare_tensors(&t_input_6.node->grad,
                        &t_expected_grad_6,
                        op_name,
                        tc_name,
                        1,
                        TEST_FLOAT_TOLERANCE);
    }

    // Test Case 7
    {
        const char* tc_name = "4d_shape_2_3_4_5_dim_0";
        TensorShape shape_7 = {2, 3, 4, 5};
        int dim_7 = 0;
        float input_data_7[] = {
            1.474789f,  -0.519416f, 0.772987f,  0.513793f,  0.358928f,  -1.248166f, 1.215024f,
            -0.499042f, -0.712523f, 0.093402f,  -1.435768f, 2.114161f,  -0.970802f, -0.293139f,
            -0.310645f, 1.072718f,  -0.732339f, 0.848594f,  2.230250f,  0.788688f,  0.818710f,
            0.110189f,  0.596008f,  -1.353641f, -1.533842f, 0.222465f,  -0.505462f, 0.735581f,
            0.294267f,  -2.310454f, -1.823522f, -0.632836f, -0.853936f, -0.440113f, 0.261468f,
            0.628521f,  1.073663f,  -1.206878f, 0.195572f,  0.067860f,  1.201953f,  0.672570f,
            0.162885f,  -0.318752f, -1.069017f, 0.150168f,  -1.795954f, -0.631950f, -0.794543f,
            0.239983f,  -0.962714f, -0.631215f, -0.126794f, -0.652402f, -1.027763f, 0.239582f,
            0.813199f,  0.763215f,  -0.191387f, 1.045356f,  0.035553f,  0.423691f,  -0.921079f,
            -0.465691f, 0.733018f,  -0.995488f, -1.165929f, -0.038222f, 1.495182f,  -1.220365f,
            0.781768f,  0.533956f,  0.570570f,  1.327856f,  -1.325767f, 0.026772f,  -0.304380f,
            -0.893432f, -0.487218f, -0.308606f, 0.575754f,  -1.920340f, -0.568058f, -1.235566f,
            0.559014f,  1.422567f,  1.470937f,  1.470600f,  0.836620f,  -0.128337f, 0.964306f,
            1.091873f,  2.125473f,  1.657596f,  0.850262f,  0.829998f,  -1.011373f, 2.523616f,
            -0.630927f, 0.489706f,  0.230201f,  2.202367f,  -0.355164f, -0.264000f, -1.112660f,
            0.016458f,  -0.148696f, 0.256844f,  0.498291f,  -2.765549f, 1.320153f,  0.056797f,
            -0.598021f, -1.354019f, -0.255769f, -0.762125f, -0.353912f, -0.369006f, -0.153019f,
            -1.089665f};
        float upstream_grad_data_7[] = {
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f};
        float expected_grad_7[] = {
            0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f, -0.000000f, 0.000000f,
            0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f, 0.000000f, -0.000000f, 0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f};

        Tensor t_input_7 = create_test_tensor(shape_7, input_data_7, true);
        Tensor t_upstream_grad_7 = create_test_tensor(shape_7, upstream_grad_data_7, false);
        Tensor t_expected_grad_7 = create_test_tensor(shape_7, expected_grad_7, false);

        Tensor t_output_7 = nn_softmax(t_input_7, dim_7);
        Tensor_backward(t_output_7, t_upstream_grad_7);

        compare_tensors(&t_input_7.node->grad,
                        &t_expected_grad_7,
                        op_name,
                        tc_name,
                        1,
                        TEST_FLOAT_TOLERANCE);
    }

    // Test Case 8
    {
        const char* tc_name = "4d_shape_2_3_4_5_dim_1";
        TensorShape shape_8 = {2, 3, 4, 5};
        int dim_8 = 1;
        float input_data_8[] = {
            0.561681f,  0.386991f,  0.700992f,  -0.175400f, -1.221304f, 1.315252f,  0.262052f,
            -1.296483f, -1.000376f, -0.049059f, -0.231204f, -0.923470f, 1.755458f,  -0.090067f,
            -0.658477f, -1.624743f, 0.779242f,  1.246339f,  0.841233f,  -0.168954f, -2.188574f,
            -1.119449f, 0.713464f,  0.836752f,  0.427087f,  -0.089142f, 0.602505f,  1.380736f,
            1.809501f,  1.535842f,  0.977647f,  0.036867f,  -0.597753f, -0.329029f, -0.593759f,
            0.445857f,  -1.010847f, -0.540897f, 1.135262f,  -0.741583f, -0.598109f, 0.714068f,
            1.211951f,  1.256436f,  1.870781f,  -0.347804f, -0.187317f, 0.268083f,  0.752065f,
            -0.409261f, 0.783845f,  -1.448883f, 0.429867f,  -0.708923f, 0.299181f,  0.294794f,
            0.746353f,  0.700991f,  3.085500f,  -0.020110f, 0.719284f,  -1.626763f, 1.026756f,
            -2.271972f, -0.224668f, 0.515021f,  -1.488521f, 1.192641f,  1.940856f,  -0.390310f,
            -0.573369f, 0.458933f,  0.996491f,  1.104303f,  0.708012f,  0.022833f,  -1.197958f,
            -0.650611f, 0.735700f,  -1.355728f, -0.851106f, 0.462304f,  0.136542f,  -0.662511f,
            0.112475f,  -0.230184f, -0.187235f, 0.168426f,  -0.861487f, -0.093247f, -1.005995f,
            -0.345442f, -1.515225f, -0.738003f, 0.932156f,  -0.418522f, -0.089483f, -0.303355f,
            0.491240f,  -1.087204f, -2.471883f, 0.178723f,  0.556631f,  1.224770f,  0.991969f,
            -0.456523f, 0.178374f,  0.010078f,  -0.576381f, -1.770423f, -0.484817f, -0.203203f,
            1.406515f,  -0.824538f, -1.138210f, 0.733394f,  -0.416151f, 0.167366f,  -0.066760f,
            1.503202f};
        float upstream_grad_data_8[] = {
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f};
        float expected_grad_8[] = {
            -0.000000f, 0.000000f, 0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f, 0.000000f,  -0.000000f,
            0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f, -0.000000f, 0.000000f,
            0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f, 0.000000f,  -0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f, -0.000000f, 0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f, 0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f};

        Tensor t_input_8 = create_test_tensor(shape_8, input_data_8, true);
        Tensor t_upstream_grad_8 = create_test_tensor(shape_8, upstream_grad_data_8, false);
        Tensor t_expected_grad_8 = create_test_tensor(shape_8, expected_grad_8, false);

        Tensor t_output_8 = nn_softmax(t_input_8, dim_8);
        Tensor_backward(t_output_8, t_upstream_grad_8);

        compare_tensors(&t_input_8.node->grad,
                        &t_expected_grad_8,
                        op_name,
                        tc_name,
                        1,
                        TEST_FLOAT_TOLERANCE);
    }

    // Test Case 9
    {
        const char* tc_name = "4d_shape_2_3_4_5_dim_2";
        TensorShape shape_9 = {2, 3, 4, 5};
        int dim_9 = 2;
        float input_data_9[] = {
            0.010760f,  0.100405f,  -1.383691f, -0.769888f, 1.195853f,  -1.022066f, -0.012783f,
            0.538006f,  -1.055005f, 1.188038f,  -0.106974f, -1.330146f, 0.137568f,  0.386421f,
            -1.093478f, -1.881092f, 0.732247f,  1.999664f,  1.194850f,  -1.598107f, 0.283570f,
            -0.342071f, 0.727294f,  -0.940179f, 3.080915f,  0.145376f,  -1.614777f, 1.112682f,
            -0.316733f, 0.897962f,  0.459663f,  -1.165369f, -0.732535f, -1.159413f, 2.247406f,
            -0.050621f, -1.504156f, -0.302434f, -0.513041f, 0.300270f,  -1.572776f, 0.513942f,
            -0.044417f, 0.164410f,  -0.974761f, 0.335461f,  -0.087529f, 0.287355f,  -1.536843f,
            0.486854f,  1.358455f,  -1.136863f, -0.877172f, -0.794430f, -1.425114f, -0.909163f,
            -0.052022f, 0.158338f,  0.574350f,  -0.518316f, -0.351622f, 1.041731f,  -1.792563f,
            0.337314f,  0.624813f,  -0.787995f, 0.930929f,  0.848330f,  2.423832f,  -0.677877f,
            -1.639693f, 0.373048f,  0.696541f,  -0.621287f, -0.094549f, 0.908195f,  1.737419f,
            1.046002f,  0.564060f,  -0.292395f, -1.443398f, 0.007105f,  -0.769770f, 0.700754f,
            0.373561f,  0.092035f,  0.562334f,  0.468080f,  -0.198245f, -0.450278f, -0.944298f,
            -0.850880f, -0.276559f, -0.007981f, 0.493513f,  -0.993513f, 2.331804f,  0.003341f,
            0.774831f,  -0.807105f, -1.219366f, -0.251807f, 0.392564f,  0.217238f,  0.282720f,
            -0.171292f, -1.394582f, -0.856184f, 0.623297f,  1.629926f,  0.092632f,  0.936860f,
            0.798362f,  -0.503815f, 1.078040f,  -0.095208f, -2.700858f, 1.573456f,  -0.783068f,
            -1.859010f};
        float upstream_grad_data_9[] = {
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f};
        float expected_grad_9[] = {
            0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f, -0.000000f, 0.000000f,
            0.000000f,  0.000000f,  0.000000f, -0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f,  -0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f,  -0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f, 0.000000f,  0.000000f,
            -0.000000f, 0.000000f,  0.000000f, 0.000000f,  0.000000f, -0.000000f, 0.000000f,
            0.000000f,  0.000000f,  0.000000f, -0.000000f, 0.000000f, 0.000000f,  0.000000f,
            0.000000f,  -0.000000f, 0.000000f, 0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f, 0.000000f,  0.000000f, 0.000000f,  0.000000f,
            0.000000f};

        Tensor t_input_9 = create_test_tensor(shape_9, input_data_9, true);
        Tensor t_upstream_grad_9 = create_test_tensor(shape_9, upstream_grad_data_9, false);
        Tensor t_expected_grad_9 = create_test_tensor(shape_9, expected_grad_9, false);

        Tensor t_output_9 = nn_softmax(t_input_9, dim_9);
        Tensor_backward(t_output_9, t_upstream_grad_9);

        compare_tensors(&t_input_9.node->grad,
                        &t_expected_grad_9,
                        op_name,
                        tc_name,
                        1,
                        TEST_FLOAT_TOLERANCE);
    }

    // Test Case 10
    {
        const char* tc_name = "4d_shape_2_3_4_5_dim_3";
        TensorShape shape_10 = {2, 3, 4, 5};
        int dim_10 = 3;
        float input_data_10[] = {
            -0.533466f, 0.851224f,  0.866751f,  0.687578f,  0.893614f,  -0.176522f, 0.259054f,
            0.616506f,  -0.329471f, -0.068180f, -2.789774f, -0.929192f, -0.040251f, 0.557579f,
            -1.587092f, 0.837130f,  -0.396975f, -0.425327f, -1.108546f, -1.497528f, -1.050783f,
            -0.618608f, 0.302976f,  -0.894611f, 0.740044f,  0.278542f,  -0.823290f, -1.026350f,
            -1.483952f, 1.162551f,  0.517106f,  -0.460962f, -1.371643f, -0.248814f, 0.682069f,
            1.154833f,  -1.403635f, 1.373101f,  -1.902848f, -0.723326f, 1.271827f,  -0.707682f,
            -0.092860f, -0.806911f, -1.742649f, 0.856783f,  1.581833f,  -1.866143f, -0.065457f,
            -1.585482f, 0.204017f,  0.444698f,  0.600724f,  -0.474215f, -1.305148f, -0.853096f,
            1.269127f,  1.701428f,  0.301171f,  0.078225f,  -0.472443f, 1.128119f,  2.771775f,
            0.348380f,  0.125561f,  1.738564f,  -0.459702f, 0.147657f,  -0.245800f, 0.484814f,
            -0.245291f, 1.815248f,  0.401230f,  -0.266132f, -0.703580f, 1.460846f,  0.358296f,
            0.947361f,  -1.496864f, 0.589258f,  0.044601f,  0.702129f,  -0.474669f, 0.388595f,
            0.255142f,  -0.898959f, 0.023422f,  0.507979f,  -0.316557f, -0.365951f, -0.438184f,
            0.291421f,  -0.066030f, -0.706016f, -0.022865f, -2.269721f, 1.083016f,  0.740388f,
            0.508656f,  0.053598f,  -0.024204f, 0.970268f,  0.723369f,  -0.281419f, -0.666052f,
            -0.236260f, 0.347583f,  0.163527f,  0.662205f,  -0.333970f, -1.201504f, 0.366744f,
            2.164139f,  0.516986f,  -0.900627f, 0.271167f,  0.374698f,  0.893020f,  0.744694f,
            -1.054701f};
        float upstream_grad_data_10[] = {
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f,
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f};
        float expected_grad_10[] = {
            0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.000000f,  -0.000000f, -0.000000f, -0.000000f,
            -0.000000f, -0.000000f, 0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,
            0.000000f,  -0.000000f, -0.000000f, -0.000000f, -0.000000f, -0.000000f, 0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.0000f,    0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,
            0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,  0.000000f,
            0.000000f};

        Tensor t_input_10 = create_test_tensor(shape_10, input_data_10, true);
        Tensor t_upstream_grad_10 = create_test_tensor(shape_10, upstream_grad_data_10, false);
        Tensor t_expected_grad_10 = create_test_tensor(shape_10, expected_grad_10, false);

        Tensor t_output_10 = nn_softmax(t_input_10, dim_10);
        Tensor_backward(t_output_10, t_upstream_grad_10);

        compare_tensors(&t_input_10.node->grad,
                        &t_expected_grad_10,
                        op_name,
                        tc_name,
                        1,
                        TEST_FLOAT_TOLERANCE);
    }

    cten_free(pool_id);
}
